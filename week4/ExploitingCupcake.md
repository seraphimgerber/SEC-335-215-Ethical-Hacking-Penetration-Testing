## Activity 4.1 - Exploiting Cupcake

The purpose of this activity is to give you a sense of some of the steps taken to recon, assess, exploit, achieve a foothold and elevate privileges on a system.

Through previous classes, we have discovered that the target organization (SHIRE) is running a webserver that purportedly runs a status application.

---

### Part 1 - Active Recon 

Q: The target is cupcake.shire.org at 10.0.5.23. What can you find out about the target? Make sure to check the top 100 TCP ports to see what ports are listening. For those ports that are open, run another scan that attempts to run version detection against the service port.

A: We ran an nmap scan using the syntax *nmap -sV -p 0-100 10.0.5.23*, which allowed us to see Port 22 was running SSH with OpenSSH version 5.3 and Port 80 was running a web server with Apache httpd on CentOS version 2.2.15.

<img width="577" height="126" alt="{B60CEA96-AF93-45AE-994D-9430B14C579E}" src="https://github.com/user-attachments/assets/ae4dfd60-2205-47d4-a1b4-5a98cc4520fc" />

Q: You should have the versions of at least two applications.  Go ahead and hit the internet and see if your group can find:

1. Related operating system (this is easy) 
2. Release (a bit harder)
3. What did you find and how did you find it?

A: The [Apache server](https://lists.apache.org/thread/7lw0j6023cfk35fy14q2f9tbgyn6lpmj) is an older version that was released on March 6, 2010, and it runs on CentOS. AlmaLinux and Rocky Linux are community-driven options that are very similar to CentOS. The [OpenSSH service](https://www.openssh.com/txt/release-5.3), specifically the 5.3 version, was released on October 1, 2009 and some variants that are very similar to it would be PuTTY or Dropbear SSH. 

---

## Part 2 - Dealing with Targets and Scans

Shows your sheet of nmap scan data against cupcake. Note, the scan in the demo did not show version detection. See if you can figure out how to do that. You will have at least two ports.

| IP | FQDN | PORT | PROTOCOL | SERVICE | VERSION |
| - | - | - | - | - | - |
| 10.0.5.23 | cupcake.shire.org | 22 | tcp | ssh | OpenSSH 5.3 |
| 10.0.5.23 | cupcake.shire.org | 80 | tcp | http | Apache httpd 2.2.15 | 

---

## Part 3 - Vulnerability Detection

Q: Based upon what you have learned about the operating system and the nature of the web service, leverage google and exploit db to find potential vulnerabilities. Take about 10 minutes to see what you can find and be prepared to present your findings. Focus on remote vulnerabilities that might give us a foothold on the target. What potential remote vulnerabilities did your team find?

A: Known vulnerabilities for OpenSSH:
- CVE-2010-4478 – Remote DoS via crafted requests
- CVE-2016-6515 – Information disclosure

Known vulnerabilities for Apache httpd 2.2.15:
- CVE-2011-3192 – Apache Range header DoS
- CVE-2012-0053 – Integer overflow in mod_proxy_ajp
- CVE-2017-3167 / CVE-2017-3169 – Authentication bypass & remote code execution in Apache 2.2.x
- CVE-2017-9798 (“Optionsbleed”) – Leak of server memory contents

---

## Part 4 - Remote Code Execution Vulnerability

Q: Just because your research indicated the potential of a vulnerability, let's see if we can confirm it both by hand and by use of an nmap script. Determine what the target's running kernel version (you would use the uname command for this). Provide a screenshot that shows the major and minor release of the kernel.

A: We used command *sudo nmap -sV -Pn -p 80 --script http-shellshock --script-args uri=/cgi-bin/status,cmd="echo ; echo ; /bin/uname -a" 10.0.5.23* to get the results of uname -a on Cupcake. 

<img width="616" height="431" alt="{046284A5-0925-4490-9CBE-44B08B7CE5A3}" src="https://github.com/user-attachments/assets/0d79b6ed-773c-4992-9fc2-ee6a53f5b1df" />

We also grabbed the results of /etc/passwd and saved it to a file called passwords.txt. 

<img width="600" height="364" alt="{DE578ADB-809C-4E79-9791-022935CDDA90}" src="https://github.com/user-attachments/assets/6346f116-8d53-4b75-a300-98d53b1d6a45" />

---

## Part 5 - The Foothold

Q: Do a case insensitive search of your search term on the contents of /usr/share/wordlists/rockyou.txt.gz. You may wish to extract the gzip or use zcat. Armed with the contents of /etc/passwd, let's see if we can build a list of likely passwords for the target account. You should end up with 28 passwords in your list. Provide a screenshot that shows how you generated the list as well as the list contents.

A: Rockyou.txt is a file of common passwords from the 2009 RockYou data breach. We used the command *gunzip* to unzip the gzip file then *mv*ed it to the same directory as our passwords.txt file from before. Then. we ran *grep -i 'samwise' rockyou.txt > passwords.txt to compare and move the results into our passwords file.

<img width="431" height="484" alt="{1534901E-A9A0-4E57-9BF4-EFD8A03A3DAF}" src="https://github.com/user-attachments/assets/d0ee0cea-337d-4a20-8556-2fccb81c7594" />

Q: Hydra is a versatile tool for testing a variety of passwords against a service like ssh.  Run your own attack against Cupcake.

A: We used command *hydra -l samwise -P passwords.txt 10.0.5.23 -t 4 ssh* to get the password for user samwise. 

<img width="606" height="165" alt="{5237F8CE-5483-4E7F-B078-4C015EDED556}" src="https://github.com/user-attachments/assets/a47ee6c2-258c-473a-a92c-664d3ac0822a" />

Password cracked! Now we can ssh into samwise. 

<img width="541" height="145" alt="{0F8E6215-B9E2-4042-A245-7E752795DC6D}" src="https://github.com/user-attachments/assets/218f4225-85ff-4415-8834-d4132f8731cf" />

---

## Part 6 - Root Compromise

Q: There is the potential here to break the system. If you've done so, this is ok. You have the power to access this target in Proxmox only to revert the snapshot and power it back on again. When using any technique the alters accounts on the system, make sure you use your own unique username so that you don't wipe out someone else's work. Show the results of the id command as well as the contents of root-flag.txt.

A: We followed the given instructions using the Dirty COW exploit for privilege escalation. Using *uname -r* we could see the Kernel version was vulnerable to this attack. We found the source code we needed on our attacker machine using *searchsploit -m 40839*, hosted the given file on a python webserver, and *wget*ed the file on the victim machine to the /tmp/ directory. 

<img width="774" height="124" alt="{D19D1456-65B0-41DC-B838-4E91E43E529D}" src="https://github.com/user-attachments/assets/ab2e0cba-3f7e-4cf8-9989-777f1f71fb39" />

Now that the file is on our victim machine, we can run the exploit using the syntax *gcc -pthread 40839.c -o dirty -lcrypt* 

<img width="757" height="261" alt="{FA809DB4-B714-47F0-8599-3EB53E304522}" src="https://github.com/user-attachments/assets/749bfe3a-e5b8-47c8-90e5-816bee8e7d49" />

This created a new user called firefart which we can switch to using *su - firefart* and gain access to the root-flag! 

<img width="581" height="75" alt="{B40E8A05-6971-4311-9C99-E88942689388}" src="https://github.com/user-attachments/assets/d0cb1048-c875-4a55-9159-3327a29ec427" />

---

## Part 7 - Reflections

Q: Reflect on the exercise with emphasis on those techniques that you didn't quite understand or questions you would like to research. This is not uncommon, this exercise demonstrates an end-to-end attack. It is not expected you will know how all the techniques used work in detail.

A: A lot of the challenges I had in this lab were from improperly copying the given syntax, especially in the earlier parts of the lab where we used the http-shellshock script and *curl*ing the User-Agent to run commands on the victim. If I fully understood the commands then it would be less likely to run into these errors, so it is definitely worth researching these attacks so I can take full advantage of their use.
